<!-- File: mini_insta/show_feed.html -->
<!-- Author: Evren Yaman (yamane@bu.edu), 10/17/2025 -->
<!-- Description: Displays a feed of Posts for a given Profile. -->

{% extends 'mini_insta/base.html' %}

{% block title %}Feed for {{ profile.display_name|default:profile.username }}{% endblock %}

{% block content %}
<div class="wrapper">
  <h1>Feed for {{ profile.display_name|default:profile.username }}</h1>
  <a href="{% url 'profile' profile.pk %}" class="btn btn-secondary">← Back to Profile</a>
</div>

{% if posts %}
  {% for post in posts %}
    <div class="wrapper">
      <!-- Post author header -->
      <div class="profile-hero" style="grid-template-columns: 80px 1fr;">
        {% if post.profile.profile_image_url %}
          <img src="{{ post.profile.profile_image_url }}"
               alt="{{ post.profile.display_name|default:post.profile.username }} avatar"
               class="profile-portrait"
               style="width:80px; height:80px;">
        {% endif %}

        <div class="profile-meta">
          <a href="{% url 'profile' post.profile.pk %}">
            <p class="profile-name">{{ post.profile.display_name|default:post.profile.username }}</p>
          </a>
          <p class="profile-username">@{{ post.profile.username }}</p>
          <p class="profile-bio">
            <time datetime="{{ post.timestamp|date:'c' }}">{{ post.timestamp }}</time>
          </p>
        </div>
      </div>

      <!-- First photo (if any) -->
      {% with first_photo=post.get_all_photos.first %}
        {% if first_photo and first_photo.get_image_url %}
          <div style="margin-top:12px;">
            <a href="{% url 'post' post.pk %}">
              <!-- Reuse profile-thumb for consistent styling -->
              <img src="{{ first_photo.get_image_url }}" alt="Post {{ post.pk }} image" class="profile-thumb" style="width:100%; height:auto;">
            </a>
          </div>
        {% endif %}
      {% endwith %}

      <!-- Caption -->
      <p class="profile-bio" style="margin-top:12px;">
        {{ post.caption }}
      </p>

      <!-- Likes summary -->
      <div class="social-stats">
        {% with likes=post.get_likes %}
          {% if likes|length == 0 %}
            ❤️ 0 likes
          {% elif likes|length == 1 %}
            ❤️ Liked by {{ likes.0.profile.display_name|default:likes.0.profile.username }}
          {% else %}
            ❤️ Liked by {{ likes.0.profile.display_name|default:likes.0.profile.username }} and {{ likes|length|add:"-1" }} others
          {% endif %}
        {% endwith %}
      </div>

      <!-- Comments (show a few newest) -->
      <section class="post-comments">
        <h3>Comments</h3>

        {% with comments=post.get_all_comments %}
            {% if comments %}
            <ul style="list-style:none; padding:0; margin:0;">
                {% for c in comments %}
                <li style="margin-bottom:0.75rem; border-bottom:1px solid #e2e8f0; padding-bottom:0.5rem;">
                    <div>
                    <a href="{% url 'profile' c.profile.pk %}" class="profile-username">
                        {{ c.profile.display_name }}
                    </a>
                    <span class="profile-bio" style="font-size:0.85rem; color:#64748b;">
                        • <time datetime="{{ c.timestamp|date:'c' }}">{{ c.timestamp }}</time>
                    </span>
                    </div>
                    <p class="profile-bio" style="margin:0.25rem 0 0;">
                    {{ c.text }}
                    </p>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="profile-bio" style="color:#64748b;">No comments yet.</p>
            {% endif %}
        {% endwith %}
      </section>
    </div>
  {% endfor %}
{% else %}
  <div class="wrapper">
    <p>Your feed is empty. Follow some profiles to see their posts here.</p>
  </div>
{% endif %}
{% endblock %}
